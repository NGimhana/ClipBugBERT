{
    "url": "https://api.github.com/repos/ankidroid/Anki-Android/issues/8155",
    "repository_url": "https://api.github.com/repos/ankidroid/Anki-Android",
    "labels_url": "https://api.github.com/repos/ankidroid/Anki-Android/issues/8155/labels{/name}",
    "comments_url": "https://api.github.com/repos/ankidroid/Anki-Android/issues/8155/comments",
    "events_url": "https://api.github.com/repos/ankidroid/Anki-Android/issues/8155/events",
    "html_url": "https://github.com/ankidroid/Anki-Android/pull/8155",
    "id": 826915776,
    "node_id": "MDExOlB1bGxSZXF1ZXN0NTg4ODc3MDQ2",
    "number": 8155,
    "title": "Release TextToSpeech with a Context",
    "user": {
        "login": "JG916",
        "id": 16379504,
        "node_id": "MDQ6VXNlcjE2Mzc5NTA0",
        "avatar_url": "https://avatars.githubusercontent.com/u/16379504?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/JG916",
        "html_url": "https://github.com/JG916",
        "followers_url": "https://api.github.com/users/JG916/followers",
        "following_url": "https://api.github.com/users/JG916/following{/other_user}",
        "gists_url": "https://api.github.com/users/JG916/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/JG916/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/JG916/subscriptions",
        "organizations_url": "https://api.github.com/users/JG916/orgs",
        "repos_url": "https://api.github.com/users/JG916/repos",
        "events_url": "https://api.github.com/users/JG916/events{/privacy}",
        "received_events_url": "https://api.github.com/users/JG916/received_events",
        "type": "User",
        "site_admin": false
    },
    "labels": [],
    "state": "closed",
    "locked": false,
    "assignee": {
        "login": "mikehardy",
        "id": 782704,
        "node_id": "MDQ6VXNlcjc4MjcwNA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/782704?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mikehardy",
        "html_url": "https://github.com/mikehardy",
        "followers_url": "https://api.github.com/users/mikehardy/followers",
        "following_url": "https://api.github.com/users/mikehardy/following{/other_user}",
        "gists_url": "https://api.github.com/users/mikehardy/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mikehardy/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mikehardy/subscriptions",
        "organizations_url": "https://api.github.com/users/mikehardy/orgs",
        "repos_url": "https://api.github.com/users/mikehardy/repos",
        "events_url": "https://api.github.com/users/mikehardy/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mikehardy/received_events",
        "type": "User",
        "site_admin": false
    },
    "assignees": [
        {
            "login": "mikehardy",
            "id": 782704,
            "node_id": "MDQ6VXNlcjc4MjcwNA==",
            "avatar_url": "https://avatars.githubusercontent.com/u/782704?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/mikehardy",
            "html_url": "https://github.com/mikehardy",
            "followers_url": "https://api.github.com/users/mikehardy/followers",
            "following_url": "https://api.github.com/users/mikehardy/following{/other_user}",
            "gists_url": "https://api.github.com/users/mikehardy/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/mikehardy/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/mikehardy/subscriptions",
            "organizations_url": "https://api.github.com/users/mikehardy/orgs",
            "repos_url": "https://api.github.com/users/mikehardy/repos",
            "events_url": "https://api.github.com/users/mikehardy/events{/privacy}",
            "received_events_url": "https://api.github.com/users/mikehardy/received_events",
            "type": "User",
            "site_admin": false
        }
    ],
    "milestone": {
        "url": "https://api.github.com/repos/ankidroid/Anki-Android/milestones/37",
        "html_url": "https://github.com/ankidroid/Anki-Android/milestone/37",
        "labels_url": "https://api.github.com/repos/ankidroid/Anki-Android/milestones/37/labels",
        "id": 6047926,
        "node_id": "MDk6TWlsZXN0b25lNjA0NzkyNg==",
        "number": 37,
        "title": "2.15 release",
        "description": "",
        "creator": {
            "login": "david-allison",
            "id": 62114487,
            "node_id": "MDQ6VXNlcjYyMTE0NDg3",
            "avatar_url": "https://avatars.githubusercontent.com/u/62114487?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/david-allison",
            "html_url": "https://github.com/david-allison",
            "followers_url": "https://api.github.com/users/david-allison/followers",
            "following_url": "https://api.github.com/users/david-allison/following{/other_user}",
            "gists_url": "https://api.github.com/users/david-allison/gists{/gist_id}",
            "starred_url": "https://api.github.com/users/david-allison/starred{/owner}{/repo}",
            "subscriptions_url": "https://api.github.com/users/david-allison/subscriptions",
            "organizations_url": "https://api.github.com/users/david-allison/orgs",
            "repos_url": "https://api.github.com/users/david-allison/repos",
            "events_url": "https://api.github.com/users/david-allison/events{/privacy}",
            "received_events_url": "https://api.github.com/users/david-allison/received_events",
            "type": "User",
            "site_admin": false
        },
        "open_issues": 1,
        "closed_issues": 651,
        "state": "closed",
        "created_at": "2020-10-29T17:44:35Z",
        "updated_at": "2022-03-11T11:40:34Z",
        "due_on": null,
        "closed_at": "2021-06-06T15:44:17Z"
    },
    "comments": 5,
    "created_at": "2021-03-10T01:33:02Z",
    "updated_at": "2021-04-05T18:37:08Z",
    "closed_at": "2021-03-20T18:47:14Z",
    "author_association": "CONTRIBUTOR",
    "active_lock_reason": null,
    "draft": false,
    "pull_request": {
        "url": "https://api.github.com/repos/ankidroid/Anki-Android/pulls/8155",
        "html_url": "https://github.com/ankidroid/Anki-Android/pull/8155",
        "diff_url": "https://github.com/ankidroid/Anki-Android/pull/8155.diff",
        "patch_url": "https://github.com/ankidroid/Anki-Android/pull/8155.patch",
        "merged_at": "2021-03-20T18:47:14Z"
    },
    "body": "## Pull Request template\r\n\r\n## Purpose / Description\r\nTextToSpeech was being released (shutdown) incorrectly due to a race condition.\r\nWhen AbstractFlashcardViewer is recreated (Ex: through changing themes), the newly created activity initialized a new TextToSpeech. \r\nThe old activity then releases that same TextToSpeech instance from onDestroy()\r\nTextToSpeech will not work until it is re-initialized.\r\n\r\n## Fixes\r\nFixes #8084\r\n\r\nhttps://user-images.githubusercontent.com/16379504/110561114-1fa2ee80-8115-11eb-9a4b-db9f48ae2677.mp4\r\n\r\n## Approach\r\nWhen TextToSpeech is initialized, a Context is passed in and stored.\r\nThat Context is always 'paired' with a single instance of TextToSpeech.\r\nBecause the caller that initialized the instance wants to make sure it cleans up when it's done, it attempts to release it.\r\nThe instance is stored in a static private field in a different class, so the caller cannot tell what the state of that instance is.\r\nTo prevent a caller from releasing an instance of TextToSpeech that was initialized by another caller, the same Context must be passed it to verify if the instance belongs to it or not.\r\n\r\nThis has some caveats though. For instance, right now the only context used is AbstractFlashcardViewer, but if you were to start passing in a shared context like the application context, this problem would re-occur.\r\n\r\nBecause of the overall structure of ReadText and its connections, it was hard to find a solution that didn't involve a massive amount of time and code changes.\r\n\r\n## How Has This Been Tested?\r\n\r\n1. Enable TTS\r\n2. Go to Study\r\n3. Change theme from hamburger menu (switch on/off night mode)\r\n4. Choose 'Replay audio' from dots menu\r\n\r\nThe audio should play after both step 3 (when the card is first shown) and step 4.\r\n\r\nTested on an emulator with API 29.\r\n\r\n## Learning (optional, can help others)\r\nhttps://developer.android.com/reference/android/speech/tts/TextToSpeech\r\nhttp://robolectric.org/javadoc/4.0/org/robolectric/shadows/ShadowTextToSpeech.html\r\n\r\n\r\n\r\nText to speech is shared through all applications. Maybe it's possible that the current usage here could be changed from a (pseudo) per-activity usage to something more like a singleton? The initialization takes quite a long time to run, and it's likely that when used once, it will be used quite often throughout the session, so a different setup and destroy system could run perform better.\r\n\r\nWhen re-initializing TextToSpeech inside ReadText, it's directly overriding the old reference without calling `shutdown()` on it beforehand. I'm wondering how much of an effect this has...\r\n\r\n\r\n## Checklist\r\n- [x] You have not changed whitespace unnecessarily (it makes diffs hard to read)\r\n- [x] You have a descriptive commit message with a short title (first line, max 50 chars).\r\n- [x] Your code follows the style of the project (e.g. never omit braces in `if` statements) \r\n- [x] You have commented your code, particularly in hard-to-understand areas\r\n- [x] You have performed a self-review of your own code\r\n- [x] UI changes: include screenshots of all affected screens (in particular showing any new or changed strings)",
    "closed_by": {
        "login": "mikehardy",
        "id": 782704,
        "node_id": "MDQ6VXNlcjc4MjcwNA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/782704?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/mikehardy",
        "html_url": "https://github.com/mikehardy",
        "followers_url": "https://api.github.com/users/mikehardy/followers",
        "following_url": "https://api.github.com/users/mikehardy/following{/other_user}",
        "gists_url": "https://api.github.com/users/mikehardy/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/mikehardy/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/mikehardy/subscriptions",
        "organizations_url": "https://api.github.com/users/mikehardy/orgs",
        "repos_url": "https://api.github.com/users/mikehardy/repos",
        "events_url": "https://api.github.com/users/mikehardy/events{/privacy}",
        "received_events_url": "https://api.github.com/users/mikehardy/received_events",
        "type": "User",
        "site_admin": false
    },
    "reactions": {
        "url": "https://api.github.com/repos/ankidroid/Anki-Android/issues/8155/reactions",
        "total_count": 1,
        "+1": 0,
        "-1": 0,
        "laugh": 0,
        "hooray": 0,
        "confused": 0,
        "heart": 1,
        "rocket": 0,
        "eyes": 0
    },
    "timeline_url": "https://api.github.com/repos/ankidroid/Anki-Android/issues/8155/timeline",
    "performed_via_github_app": null,
    "state_reason": null
}